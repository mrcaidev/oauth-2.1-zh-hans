# 2.3. 客户端重定向端点

客户端重定向端点（也被称为“重定向端点”）是授权服务器在与资源所有者完成交互后，将用户代理重定向回到的客户端 URI。

在客户端注册的过程中，客户端预先与授权服务器上建立了一系列客户端重定向端点。授权服务器将用户代理重定向到这些端点中的其一。

重定向 URI **必须**是由 [[RFC3986](https://www.rfc-editor.org/info/rfc3986)] 第 4.3 节定义的绝对 URI。重定向 URI **可以**包含一个查询字符串（附录 C.1），后续在添加额外的查询参数时**必须**保留该部分。重定向 URI **禁止**包含片段部分。

## 2.3.1. 注册要求

授权服务器**必须**要求客户端注册它们的完整重定向 URI（包括路径部分）。授权服务器**必须**拒绝指定的重定向 URI 与注册的 URI 不精确匹配的授权请求。但对于回环重定向，URI 端口部分可以不精确匹配，详见第 4.1.1 节。

授权服务器**可以**允许客户端注册多个重定向 URI。

注册可以不使用网络通信进行，例如在授权服务器上手动配置客户端信息，或者也可以在运行时进行，例如推送授权请求 [[RFC9126](https://www.rfc-editor.org/info/rfc9126)] 中的初始 POST 请求。

对于基于私用 URI 方案的重定向 URI，授权服务器**应该**执行第 8.4.3 节的要求，也就是客户端需要使用基于反向域名的方案。至少，任何不包含句号（.）的私用 URI 方案都**应该**被拒绝。

除了抗碰撞属性外，这还可以在发生特定争议时帮助证明所有权，争议中的两个应用声称使用相同的私用 URI 方案（其中一个应用是恶意行为）。例如，如果两个应用声称使用 com.example.app，example.com 的所有者可以向应用商店运营商申请移除伪造的应用。如果使用通用 URI 方案，则更难以证明此类申请。

客户端**禁止**暴露如 7.12 节所述的，将用户浏览器转发到查询参数中的任意 URI 的 URL（开放式重定向 URL）。这种 URL 可能导致授权码和访问令牌的渗透。

客户端**可以**使用 state 查询参数，以按需定制每个请求，而非改变每个请求的重定向 URI。

如果不要求注册重定向 URI，攻击者就可以将授权端点作为开放式重定向 URL，如第 7.12 节所述。

## 2.3.2. 多个重定向 URI

如果客户端注册了多个重定向 URI，那么客户端**必须**在授权请求中使用 redirect_uri 请求参数（第 4.1.1 节）包含目标重定向 URI。如果客户端只注册了一个重定向 URI，redirect_uri 请求参数就是可选的。

## 2.3.3. 防止 CSRF 攻击

客户端**必须**预防跨站请求伪造（CSRF）攻击。在这一语境中，CSRF 指请求的重定向端点不来自授权服务器，而是来自恶意的第三方（详见 [[RFC6819](https://www.rfc-editor.org/info/rfc6819)] 的第 4.4.1.8 节）。已经确保授权服务器支持 code_challenge 参数的客户端**可以**依赖该机制提供的 CSRF 保护。在 OpenID Connect 流程中，验证 nonce 参数提供了 CSRF 保护。否则，**必须**使用 state 参数中携带的、与用户代理安全绑定的、一次性使用的 CSRF 令牌，以实现 CSRF 保护（见第 7.9 节）。

## 2.3.4. 防止混淆攻击

如果 OAuth 客户端只能够和一台授权服务器交互，那么混淆攻击防御不是必需的。但如果 OAuth 客户端和两台或多台授权服务器交互，那么客户端就**必须**防止混淆攻击。为了防止混淆攻击，客户端**必须**仅处理其发送相应请求的发行者的重定向响应，并且只能来自发起此授权请求的同一用户代理。

第 7.13 节详细描述了两种不同的混合攻击防御。

## 2.3.5. 无效端点

如果授权请求由于缺失、无效或不匹配的重定向 URI 而验证失败，授权服务器**应该**告知资源所有者该错误，并且**禁止**自动将用户代理重定向到无效的重定向 URI。

## 2.3.6. 端点内容

对客户端端点的重定向请求通常以 HTML 文档为响应，并由用户代理进行处理。如果 HTML 响应被直接作为重定向请求的结果，那么 HTML 文档中包含的任何脚本在执行时，都拥有重定向 URI 以及其中包含的内容（例如，授权码）的完全访问权限。此外，包含授权码的请求 URL 可能会被携带在 HTTP Referer 头部中，发送给页面中加载的所有嵌入图像、样式表和其他元素。

客户端**不应该**在重定向 URI 端点响应中包含任何第三方脚本（例如第三方分析、社交插件、广告网络）。相反，它**应该**从 URI 中提取出内容，并将用户代理再次重定向到另一个端点，而不暴露其中的内容（无论是在 URI 中还是其他地方）。如果包含了第三方脚本，客户端**必须**确保自己的（用于从 URI 中提取和移除凭证的）脚本会首先执行。
